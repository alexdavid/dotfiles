#!/usr/bin/env bash

last_status=$1

function set_bg {
  printf "[48;5;$1m"
}

function set_fg {
  printf "[38;5;$1m"
}

function reset_fg {
  printf "[39m"
}

function reset_bg {
  printf "[49m"
}

CURRENT_COLOR=0

function section {
  OLD_COLOR=$CURRENT_COLOR
  CURRENT_COLOR=$1
  SECTION_TEXT="${@:2}"

  set_bg $CURRENT_COLOR
  if [ $OLD_COLOR -ne 0 ]; then
    set_fg $OLD_COLOR
    [ "$TERM" == "xterm-termite" ] && printf "î‚°"
    reset_fg
  fi
  set_fg 0
  printf " $SECTION_TEXT "
}

function end_sections {
  reset_bg
  set_fg $CURRENT_COLOR
  [ "$TERM" == "xterm-termite" ] && printf "î‚°"
  printf " "
  reset_fg
}

if [ "$(id -u)" -eq 0 ]; then
  section 208 $(whoami)
fi

home_dir=$(echo $HOME | sed 's/\//\\\//g')
FORMATTED_DIR=$(pwd | sed "s/$home_dir/~/")
CURRENT_DIR=$(basename "$FORMATTED_DIR")
PARENT_DIR=$(basename "$(dirname "$FORMATTED_DIR")")
[ "$PARENT_DIR" != "." -a "$PARENT_DIR" != "/" ] && section 15 $PARENT_DIR
section 2 $CURRENT_DIR


if git rev-parse --git-dir > /dev/null 2>&1; then
  section 3 î‚  $(git rev-parse --abbrev-ref HEAD 2> /dev/null)
fi

if [ $last_status -ne 0 ]; then
  section 1 $last_status
fi

end_sections
